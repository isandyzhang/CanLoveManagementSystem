@{
    ViewData["Title"] = "查詢個案 - 開案紀錄";
    ViewData["Breadcrumbs"] = new List<(string Text, string Url)>
    {
        ("個案管理", Url.Action("Index", "Case") ?? string.Empty),
        ("查詢個案", Url.Action("SearchForOpenCase", "Case") ?? string.Empty),
        ("開案紀錄", string.Empty)
    };
}

<div class="w-full px-4 sm:px-6 lg:px-8">
    <div class="max-w-[1400px] mx-auto">
        @{ ViewBag.CurrentPage = "Search"; ViewBag.CurrentTab = "CaseOpening"; }
        <partial name="~/Views/Case/Partials/_CaseTabs.cshtml" />
        <div class="card bg-white dark:bg-white shadow-card-lg border rounded-xl border-[#FDBA74]">
            <!-- 頂部色塊樣式（與個案基本資料表一致，但使用橘色系） -->
            <div class="-mx-6 -mt-6 mb-5 px-6 py-4 rounded-t-xl flex items-center justify-between bg-[#FFF1E6]">
                <span class="inline-flex items-center gap-3 text-2xl font-bold text-slate-800">
                    <i class="bi bi-clipboard-check"></i>
                    開案紀錄表
                </span>
            </div>
            <div class="px-6 py-6">
                <p class="text-slate-600 mb-4">搜尋個案並直接進入開案流程 Step1。</p>
                <div class="mb-4">
                    <label for="openSearchInput" class="block text-sm text-slate-700 mb-1">搜尋個案（編號/姓名/電話）</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 border border-r-0 border-border rounded-l-md bg-slate-50 text-slate-500"><i class="fas fa-search"></i></span>
                        <input type="text" id="openSearchInput" class="input flex-1 rounded-l-none" placeholder="請輸入關鍵字..." autocomplete="off" />
                        <span id="openSearchLoading" class="hidden items-center px-3 border border-l-0 border-border rounded-r-md"><span class="spinner-border spinner-border-sm" role="status"></span></span>
                    </div>
                </div>

                <div id="openSearchResults" class="d-none">
                    <div class="overflow-auto">
                        <table class="data-table text-left w-full text-slate-900">
                            <thead>
                                <tr class="bg-[#FFF8F1]">
                                    <th class="text-slate-700">個案編號</th>
                                    <th class="text-slate-700">姓名</th>
                                    <th class="text-slate-700">出生日期</th>
                                    <th class="text-slate-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="openResultsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function(){
  const input = document.getElementById('openSearchInput');
  const loading = document.getElementById('openSearchLoading');
  const container = document.getElementById('openSearchResults');
  const list = document.getElementById('openResultsList');
  let timer;
  input.addEventListener('input', function(){
    clearTimeout(timer);
    const q = this.value.trim();
    if(!q){container.classList.add('d-none'); list.innerHTML=''; return;}
    loading.classList.remove('hidden');
    timer = setTimeout(async () => {
      try{
        const resp = await fetch(`/Case/SearchCases?query=${encodeURIComponent(q)}`);
        const data = await resp.json();
        loading.classList.add('hidden');
        if(data.success && data.cases && data.cases.length){
          container.classList.remove('d-none');
          list.innerHTML = data.cases.map(c => `
            <tr class="border-b border-border">
              <td><code>${escapeHtml(c.caseId||'')}</code></td>
              <td>${escapeHtml(c.name||'')}</td>
              <td>${escapeHtml(c.birthDate||'')}</td>
              <td><a class="badge-pill bg-primary text-white" href="/CaseWizardOpenCase/Step1?caseId=${encodeURIComponent(c.caseId)}">前往開案</a></td>
            </tr>`).join('');
        }else{
          container.classList.add('d-none'); list.innerHTML='';
        }
      }catch(e){
        console.error(e); loading.classList.add('hidden');
        container.classList.add('d-none'); list.innerHTML='';
      }
    }, 400);
  });
  function escapeHtml(t){ if(!t) return ''; const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
})();
</script>
}


