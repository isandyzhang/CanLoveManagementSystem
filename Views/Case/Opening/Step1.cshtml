@model CanLove_Backend.Domain.Case.ViewModels.Opening.CaseWizard_S1_CD_ViewModel

@{
    ViewData["Title"] = "開案紀錄表";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // 自訂麵包屑：首頁 > 個案管理 > 新增個案 > 開案紀錄表
    ViewData["Breadcrumbs"] = new List<(string Text, string Url)>
    {
        ("個案管理", Url.Action("Query", "CaseBasic") ?? string.Empty),
        ("新增個案", Url.Action("Create", "CaseBasic") ?? string.Empty),
        ("開案紀錄表", string.Empty)
    };
}

<div class="w-full px-4 sm:px-6 lg:px-8">
    <div class="max-w-[1400px] mx-auto">
        <div class="w-full">

            @{ ViewBag.CurrentPage = "Create"; ViewBag.CurrentTab = "CaseOpening"; }
            <partial name="~/Views/Shared/Partials/_CaseTabs.cshtml" />

            @{
                ViewBag.CurrentStep = 1;
                ViewBag.CaseId = Model.CaseId;
                var hasCaseId = !string.IsNullOrEmpty(Model.CaseId);
            }
            
            <!-- 如果沒有選擇個案，顯示選擇個案區塊 -->
            @if (!hasCaseId)
            {
                <div class="row justify-content-center mb-4">
                    <div class="col-lg-8">
                        <div class="card bg-white dark:bg-slate-900 rounded-xl shadow-card-lg border border-orange-400 dark:border-slate-700">
                            <div class="px-6 py-4 rounded-t-xl bg-orange-50">
                                <h5 class="mb-0 text-slate-900">
                                    <i class="bi bi-person-plus me-1"></i>請先選擇個案
                                </h5>
                            </div>
                            <div class="px-6 py-6">
                                <p class="text-slate-600 dark:text-slate-400 mb-4">請輸入個案編號、姓名或電話號碼進行搜尋</p>
                                
                                <!-- 搜尋輸入框 -->
                                <div class="mb-4">
                                    <label for="caseSearchInput" class="block text-sm text-slate-700 mb-1">搜尋個案</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 border border-r-0 border-border rounded-l-md bg-slate-50 text-slate-500"><i class="bi bi-search"></i></span>
                                        <input type="text" id="caseSearchInput" class="input flex-1 rounded-l-none" placeholder="請輸入個案編號、姓名或電話號碼..." autocomplete="off" />
                                        <span id="caseSearchLoading" class="hidden items-center px-3 border border-l-0 border-border rounded-r-md"><span class="spinner-border spinner-border-sm" role="status"></span></span>
                                    </div>
                                </div>

                                <!-- 搜尋結果（表格樣式，對齊個案審核列表） -->
                                <div id="caseSearchResults" class="d-none">
                                    <div class="card bg-white rounded-xl border border-border shadow-sm">
                                        <div class="p-3 pb-0">
                                            <h6 class="text-slate-900 mb-2">搜尋結果</h6>
                                        </div>
                                        <div class="p-3 pt-0 overflow-auto">
                                            <table class="data-table text-left w-full text-slate-900">
                                                <thead>
                                                    <tr class="bg-slate-50">
                                                        <th class="text-slate-700">姓名</th>
                                                        <th class="text-slate-700">出生日期</th>
                                                        <th class="text-slate-700">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="caseResultsList">
                                                    <!-- 動態插入 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- 移除多餘提示，保持乾淨介面 -->
                            </div>
                        </div>
                    </div>
                </div>
            }
            
            <!-- 導航分頁和進度條（只在有 caseId 時顯示） -->
            @if (hasCaseId)
            {
                @await Html.PartialAsync("~/Views/Case/Opening/_WizardNavigation.cshtml")
            }

            <!-- 表單（只在有 caseId 時顯示） -->
            @if (hasCaseId)
            {
            <form asp-action="Step1" method="post" class="needs-validation case-detail-form prevent-double-submit" novalidate>
                <div class="card bg-white dark:bg-slate-900 rounded-xl shadow-card-lg border border-orange-400 dark:border-slate-700">
                    <div class="px-6 py-4 mb-5 flex items-center justify-between bg-orange-50 rounded-t-xl">
                        <span class="inline-flex items-center gap-3 text-2xl font-bold text-slate-800">
                            <i class="bi bi-card-text"></i>
                            個案詳細資料
                        </span>
                    </div>
                    <div class="px-6 py-6">
                                <partial name="~/Views/Shared/Partials/_ValidationSummary.cshtml" model="ViewData.ModelState" />
                                <!-- 隱藏欄位 -->
                                <input asp-for="CaseId" type="hidden" />

                                <partial name="~/Views/Case/Opening/Partials/_Step1FormFields.cshtml" model="Model" />

                                <partial name="~/Views/Case/Opening/Partials/_CaseWizardFormActions.cshtml" model="Model" />
                    </div>
                </div>
            </form>
            }
        </div>
    </div>
</div>

@section Scripts {
    @if (!hasCaseId)
    {
    <script>
        // 個案搜尋功能
        (function() {
            const searchInput = document.getElementById('caseSearchInput');
            const searchResults = document.getElementById('caseSearchResults');
            const resultsList = document.getElementById('caseResultsList');
            const searchLoading = document.getElementById('caseSearchLoading');

            let searchTimeout;

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                // 清除之前的延遲
                clearTimeout(searchTimeout);

                // 如果輸入為空，清空並隱藏結果
                if (query === '') {
                    hideAll();
                    return;
                }

                // 顯示載入中
                searchLoading.classList.remove('d-none');

                // 設定延遲搜尋（防抖，500ms）
                searchTimeout = setTimeout(async function() {
                    try {
                        const response = await fetch(`/Case/SearchCases?query=${encodeURIComponent(query)}`);
                        const data = await response.json();

                        searchLoading.classList.add('d-none');

                        if (data.success && data.cases && data.cases.length > 0) {
                            displayResults(data.cases);
                        } else {
                            hideAll();
                        }
                    } catch (error) {
                        console.error('搜尋失敗:', error);
                        searchLoading.classList.add('d-none');
                        hideAll();
                        alert('搜尋時發生錯誤，請稍後再試');
                    }
                }, 500);
            });

            function displayResults(cases) {
                hideAll();
                searchResults.classList.remove('d-none');

                // 表格列渲染：姓名 / 出生日期 / 操作
                resultsList.innerHTML = cases.map(c => `
                    <tr class="border-b border-border">
                        <td class="text-slate-900">
                            <span class="fw-semibold">${escapeHtml(c.name || '')}</span>
                        </td>
                        <td class="text-slate-900">${c.birthDate ? escapeHtml(c.birthDate) : ''}</td>
                        <td>
                            <a class="badge-pill bg-primary text-white" href="@Url.Action("Create", "CaseOpening", new { step = "CaseDetail" })?caseId=${encodeURIComponent(c.caseId)}">選擇</a>
                        </td>
                    </tr>
                `).join('');
            }

            function hideAll() {
                searchResults.classList.add('d-none');
                resultsList.innerHTML = '';
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // 初始聚焦到搜尋框
            searchInput.focus();
        })();
    </script>
    }
    <script>
        // 表單驗證
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // 家庭結構類型選擇時顯示/隱藏其他描述欄位
        document.getElementById('familyStructureSelect').addEventListener('change', function() {
            const otherDescField = document.querySelector('input[name="FamilyStructureOtherDesc"]');
            const otherDescContainer = otherDescField.closest('.col-md-6');
            
            if (this.value) {
                // 檢查是否選擇了"其他"選項（假設最後一個選項是"其他"）
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.textContent.includes('其他') || selectedOption.textContent.includes('Other')) {
                    otherDescContainer.style.display = 'block';
                    otherDescField.required = true;
                } else {
                    otherDescContainer.style.display = 'block';
                    otherDescField.required = false;
                    otherDescField.value = '';
                }
            } else {
                otherDescContainer.style.display = 'none';
                otherDescField.required = false;
                otherDescField.value = '';
            }
        });

        // 初始化時檢查家庭結構類型
        document.addEventListener('DOMContentLoaded', function() {
            const familyStructureSelect = document.getElementById('familyStructureSelect');
            if (familyStructureSelect.value) {
                familyStructureSelect.dispatchEvent(new Event('change'));
            }
        });
    </script>
}

