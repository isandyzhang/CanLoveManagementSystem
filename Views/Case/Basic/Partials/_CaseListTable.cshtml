@model IEnumerable<CanLove_Backend.Domain.Case.Models.Basic.Case>
@{
    // 配置參數
    var mode = ViewBag.TableMode as string ?? "Search"; // Search, Review
    var showActions = ViewBag.ShowActions as bool? ?? true;
    var actionButtons = ViewBag.ActionButtons as List<(string Text, string Action, string Controller, string Class)> ?? new List<(string, string, string, string)>();
    var submitterNameMap = ViewBag.SubmitterNameMap as System.Collections.Generic.IDictionary<string, string>;
    var onRowClick = ViewBag.OnRowClick as string ?? "viewCaseDetails"; // JavaScript 函數名稱
    var emptyMessage = ViewBag.EmptyMessage as string ?? "沒有資料";
}

@if (Model != null && Model.Any())
{
    <div class="card bg-white dark:bg-slate-900 rounded-xl shadow-card-lg border border-[#9CCC65] dark:border-slate-800 mb-6">
        <div class="p-4 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">
            <div class="overflow-auto">
                <table class="data-table text-left w-full text-slate-900 dark:text-slate-100">
                    <thead>
                        <tr class="bg-slate-50 dark:bg-slate-800">
                            <th class="text-slate-700 dark:text-slate-300">個案編號</th>
                            <th class="text-slate-700 dark:text-slate-300">個案姓名</th>
                            @if (mode == "Search")
                            {
                                <th class="text-slate-700 dark:text-slate-300">性別</th>
                                <th class="text-slate-700 dark:text-slate-300">出生日期</th>
                                <th class="text-slate-700 dark:text-slate-300">城市</th>
                                <th class="text-slate-700 dark:text-slate-300">建立者</th>
                                <th class="text-slate-700 dark:text-slate-300">建立時間</th>
                            }
                            else if (mode == "Review")
                            {
                                <th class="text-slate-700 dark:text-slate-300">提交者</th>
                                <th class="text-slate-700 dark:text-slate-300">提交時間</th>
                                <th class="text-slate-700 dark:text-slate-300">狀態</th>
                            }
                            @if (showActions && actionButtons.Any())
                            {
                                <th class="text-slate-700 dark:text-slate-300">操作</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr class="border-b border-border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer" onclick="@(onRowClick)('@item.CaseId')">
                                <td class="text-slate-900 dark:text-slate-100">
                                    <code class="text-slate-900 dark:text-slate-100">@item.CaseId</code>
                                </td>
                                <td class="text-slate-900 dark:text-slate-100">@item.Name</td>
                                
                                @if (mode == "Search")
                                {
                                    <td>
                                        @{ var g = (item.Gender ?? string.Empty).Trim().ToUpper(); }
                                        @if (g == "M" || g == "男")
                                        {
                                            <span class="badge-pill bg-blue-100 text-blue-900 text-sm">男</span>
                                        }
                                        else if (g == "F" || g == "女")
                                        {
                                            <span class="badge-pill bg-pink-100 text-pink-900 text-sm">女</span>
                                        }
                                        else if (g == "O" || g == "其他")
                                        {
                                            <span class="badge-pill bg-muted">其他</span>
                                        }
                                        else
                                        {
                                            <span class="badge-pill bg-muted">未設定</span>
                                        }
                                    </td>
                                    <td class="text-slate-900 dark:text-slate-100">@item.BirthDate.ToTaiwanDateString()</td>
                                    <td class="text-slate-900 dark:text-slate-100">@(item.City?.CityName ?? "未設定")</td>
                                    <td>
                                        @{
                                            var displayName = item.SubmittedBy ?? "系統";
                                            if (displayName.Contains("@"))
                                            {
                                                displayName = displayName.Split('@')[0];
                                            }
                                        }
                                        <small class="text-slate-900 dark:text-slate-100">@displayName</small>
                                    </td>
                                    <td class="text-slate-900 dark:text-slate-100"><datetime value="@item.CreatedAt"></datetime></td>
                                }
                                else if (mode == "Review")
                                {
                                    <td>
                                        @{ 
                                            var raw = item.SubmittedBy ?? "系統";
                                            var name = (submitterNameMap != null && item.SubmittedBy != null && submitterNameMap.ContainsKey(item.SubmittedBy)) 
                                                ? (submitterNameMap[item.SubmittedBy] ?? raw) 
                                                : raw;
                                        }
                                        <span class="text-slate-900 dark:text-slate-100">@name</span>
                                    </td>
                                    <td class="text-slate-900 dark:text-slate-100"><datetime value="@item.SubmittedAt"></datetime></td>
                                    <td class="text-slate-900 dark:text-slate-100">
                                        <span class="badge-pill bg-orange-300 text-orange-900 text-sm">待審閱</span>
                                    </td>
                                }
                                
                                @if (showActions && actionButtons.Any())
                                {
                                    <td>
                                        @foreach (var button in actionButtons)
                                        {
                                            <a href="@Url.Action(button.Action, button.Controller, new { id = item.CaseId })" 
                                               class="btn btn-sm @button.Class" 
                                               onclick="event.stopPropagation();">
                                                @button.Text
                                            </a>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <partial name="~/Views/Shared/Partials/_EmptyState.cshtml" />
}

