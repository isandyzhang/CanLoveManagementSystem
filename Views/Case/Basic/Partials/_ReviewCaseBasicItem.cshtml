@model CanLove_Backend.Domain.Case.ViewModels.Basic.CaseFormViewModel
@{
    var caseId = Model?.Case?.CaseId ?? string.Empty;
    var caseName = Model?.Case?.Name ?? string.Empty;
}

<div class="card bg-white dark:bg-slate-900 rounded-xl shadow-card-lg border border-[#9CCC65] dark:border-slate-800">
    <div class="px-6 py-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-100">個案詳細資料</h3>
            <button type="button" id="closeCaseDetails" class="btn btn--secondary">
                <i class="bi bi-x-circle me-1"></i>關閉
            </button>
        </div>
        <partial name="~/Views/Case/Basic/Partials/_CaseFormFields.cshtml" model="Model" />
        
        <div class="mt-6 flex justify-end gap-3">
            <form method="post" asp-action="ReviewItemDecision" asp-controller="CaseBasic" class="inline prevent-double-submit">
                @Html.AntiForgeryToken()
                <input type="hidden" name="caseId" value="@caseId" />
                <input type="hidden" name="approved" value="true" />
                <button type="submit" class="btn bg-green-400 hover:bg-green-500 text-white">
                    <i class="bi bi-check-circle me-1"></i>通過
                </button>
            </form>
            <form method="post" asp-action="ReviewItemDecision" asp-controller="CaseBasic" class="inline prevent-double-submit">
                @Html.AntiForgeryToken()
                <input type="hidden" name="caseId" value="@caseId" />
                <input type="hidden" name="approved" value="false" />
                <button type="submit" class="btn bg-red-400 hover:bg-red-500 text-white">
                    <i class="bi bi-x-circle me-1"></i>拒絕
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    // 關閉個案詳細資料
    (function() {
        const closeBtn = document.getElementById('closeCaseDetails');
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                window.location.href = '@Url.Action("Review", "CaseBasic")';
            });
        }
    })();

    // 載入地區資料
    (function() {
            const districtsByCity = @Html.Raw(Json.Serialize(ViewBag.DistrictsByCity));
            const citySelect = document.getElementById('citySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            function loadDistrictsForCity(cityId, preserveDistrictId = null) {
                if (!citySelect || !districtSelect) return;
                
                const cityIdKey = cityId ? parseInt(cityId) : null;
                
                if (preserveDistrictId === null) {
                    preserveDistrictId = districtSelect.value;
                }
                
                districtSelect.innerHTML = '<option value="">請選擇地區</option>';
                
                if (cityIdKey && districtsByCity[cityIdKey]) {
                    districtsByCity[cityIdKey].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.districtId;
                        option.textContent = district.districtName;
                        if (preserveDistrictId && preserveDistrictId == district.districtId) {
                            option.selected = true;
                        }
                        districtSelect.appendChild(option);
                    });
                    districtSelect.disabled = false;
                } else {
                    districtSelect.disabled = !cityIdKey;
                }
            }
            
            if (citySelect && districtSelect) {
                const selectedCityId = citySelect.value;
                const currentDistrictId = districtSelect.value || districtSelect.getAttribute('data-current-district-id');
                
                if (selectedCityId) {
                    const loadDistricts = () => {
                        loadDistrictsForCity(selectedCityId, currentDistrictId);
                    };
                    
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            setTimeout(loadDistricts, 200);
                        });
                    } else {
                        setTimeout(loadDistricts, 200);
                    }
                }
                
                citySelect.addEventListener('change', function() {
                    loadDistrictsForCity(this.value);
                });
            }
        })();

        // 載入已存在的照片
        (function() {
            const photoUrl = @Html.Raw(Json.Serialize(ViewBag.PhotoUrl));
            const photoBlobId = @Html.Raw(Json.Serialize(ViewBag.PhotoBlobId));
            
            function loadPhoto() {
                const photoPreviewContainer = document.getElementById('photoPreviewContainer');
                const photoPlaceholder = document.getElementById('photoPlaceholder');
                const photoLoadingContainer = document.getElementById('photoLoadingContainer');
                const previewImage = document.getElementById('previewImage');

                if (!photoPreviewContainer || !photoPlaceholder || !photoLoadingContainer || !previewImage) {
                    return;
                }

                if (photoUrl && photoUrl.trim() !== '') {
                    photoPlaceholder.classList.add('hidden');
                    photoPreviewContainer.classList.add('hidden');
                    photoLoadingContainer.classList.remove('hidden');
                    
                    previewImage.onload = function() {
                        photoLoadingContainer.classList.add('hidden');
                        photoPlaceholder.classList.add('hidden');
                        photoPreviewContainer.classList.remove('hidden');
                    };
                    
                    previewImage.onerror = function() {
                        photoLoadingContainer.classList.add('hidden');
                        photoPreviewContainer.classList.add('hidden');
                        photoPlaceholder.classList.remove('hidden');
                    };
                    
                    previewImage.src = photoUrl;
                } else {
                    photoLoadingContainer.classList.add('hidden');
                    photoPreviewContainer.classList.add('hidden');
                    photoPlaceholder.classList.remove('hidden');
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(loadPhoto, 100);
                });
            } else {
                setTimeout(loadPhoto, 100);
            }
        })();
    </script>

