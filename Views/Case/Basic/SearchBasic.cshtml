@{
    ViewData["Title"] = "查詢個案 - 個案基本資料";
    ViewData["Breadcrumbs"] = new List<(string Text, string Url)>
    {
        ("個案管理", Url.Action("Query", "CaseBasic") ?? string.Empty),
        ("查詢個案", Url.Action("Query", "CaseBasic") ?? string.Empty),
        ("個案基本資料", string.Empty)
    };
}

<div class="w-full px-4 sm:px-6 lg:px-8">
    <div class="max-w-[1400px] mx-auto">
        @{ ViewBag.CurrentPage = "Search"; ViewBag.CurrentTab = "CaseBasic"; }
        <partial name="~/Views/Shared/Partials/_CaseTabs.cshtml" />
        
        <!-- 搜尋區 -->
        <div class="card bg-white dark:bg-slate-900 shadow-card-lg border rounded-xl border-[#9CCC65] dark:border-slate-700 mb-6">
            <div class="px-6 py-6">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                    <label for="basicSearchInput" class="block text-sm text-slate-700 mb-1">搜尋個案（編號/姓名/電話）</label>
                        <button type="button" id="showAllCasesBtn" class="btn btn-sm btn--secondary">
                            <i class="bi bi-list-ul me-1"></i>顯示全部個案
                        </button>
                    </div>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 border border-r-0 border-border rounded-l-md bg-slate-50 text-slate-500"><i class="bi bi-search"></i></span>
                        <input type="text" id="basicSearchInput" class="input flex-1 rounded-l-none" placeholder="請輸入關鍵字..." autocomplete="off" value="@(ViewBag.SelectedCase != null ? ((CanLove_Backend.Domain.Case.ViewModels.Basic.CaseFormViewModel)ViewBag.SelectedCase).Case.CaseId : "")" />
                        <span id="basicSearchLoading" class="hidden items-center px-3 border border-l-0 border-border rounded-r-md"><span class="spinner-border spinner-border-sm" role="status"></span></span>
                    </div>
                </div>

                <div id="basicSearchResults" class="d-none">
                    <div class="overflow-auto">
                        <table class="data-table text-left w-full text-slate-900">
                            <thead>
                                <tr class="bg-slate-50">
                                    <th class="text-slate-700">個案編號</th>
                                    <th class="text-slate-700">姓名</th>
                                    <th class="text-slate-700">出生日期</th>
                                    <th class="text-slate-700">城市</th>
                                    <th class="text-slate-700">地區</th>
                                    <th class="text-slate-700">學校</th>
                                    <th class="text-slate-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="basicResultsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 全部個案列表區（原本 Index 的功能） -->
        @if (ViewBag.ShowAllCases == true && ViewBag.AllCases != null)
        {
            var allCases = ViewBag.AllCases as IEnumerable<CanLove_Backend.Domain.Case.Models.Basic.Case> ?? new List<CanLove_Backend.Domain.Case.Models.Basic.Case>();
            var caseCount = allCases.Count();
            
            <div class="card bg-white dark:bg-slate-900 shadow-card-lg border rounded-xl border-[#9CCC65] dark:border-slate-700 mb-6">
                <div class="px-6 py-4 border-b border-border dark:border-slate-700 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300">全部已審核個案</h3>
                    <span class="text-sm text-slate-600 dark:text-slate-400">共 @caseCount 筆</span>
                </div>
                <div class="px-6 py-6">
                    @if (caseCount > 0)
                    {
                        <div class="overflow-auto">
                            <table class="data-table text-left w-full text-slate-900 dark:text-slate-100">
                                <thead>
                                    <tr class="bg-slate-50 dark:bg-slate-800">
                                        <th class="text-slate-700 dark:text-slate-300">個案編號</th>
                                        <th class="text-slate-700 dark:text-slate-300">姓名</th>
                                        <th class="text-slate-700 dark:text-slate-300">性別</th>
                                        <th class="text-slate-700 dark:text-slate-300">出生日期</th>
                                        <th class="text-slate-700 dark:text-slate-300">城市</th>
                                        <th class="text-slate-700 dark:text-slate-300">建立者</th>
                                        <th class="text-slate-700 dark:text-slate-300">建立時間</th>
                                        <th class="text-slate-700 dark:text-slate-300">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in allCases)
                                    {
                                        <tr class="border-b border-border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer" onclick="viewCaseDetails('@item.CaseId')">
                                            <td class="text-slate-900 dark:text-slate-100">
                                                <code class="text-slate-900 dark:text-slate-100">@item.CaseId</code>
                                            </td>
                                            <td class="text-slate-900 dark:text-slate-100">@item.Name</td>
                                            <td>
                                                @{ var g = (item.Gender ?? string.Empty).Trim().ToUpper(); }
                                                @if (g == "M" || g == "男")
                                                {
                                                    <span class="badge-pill bg-blue-100 text-blue-900 text-sm">男</span>
                                                }
                                                else if (g == "F" || g == "女")
                                                {
                                                    <span class="badge-pill bg-pink-100 text-pink-900 text-sm">女</span>
                                                }
                                                else if (g == "O" || g == "其他")
                                                {
                                                    <span class="badge-pill bg-muted">其他</span>
                                                }
                                                else
                                                {
                                                    <span class="badge-pill bg-muted">未設定</span>
                                                }
                                            </td>
                                            <td class="text-slate-900 dark:text-slate-100">@item.BirthDate.ToTaiwanDateString()</td>
                                            <td class="text-slate-900 dark:text-slate-100">@(item.City?.CityName ?? "未設定")</td>
                                            <td>
                                                @{
                                                    var displayName = item.SubmittedBy ?? "系統";
                                                    if (displayName.Contains("@"))
                                                    {
                                                        displayName = displayName.Split('@')[0];
                                                    }
                                                }
                                                <small class="text-slate-900 dark:text-slate-100">@displayName</small>
                                            </td>
                                            <td class="text-slate-900 dark:text-slate-100"><datetime value="@item.CreatedAt"></datetime></td>
                                            <td>
                                                <button type="button" class="btn btn-sm" onclick="event.stopPropagation(); viewCaseDetails('@item.CaseId')">
                                                    <i class="bi bi-eye me-1"></i>查看
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <partial name="~/Views/Shared/Partials/_EmptyState.cshtml" />
                    }
                </div>
            </div>
        }

        <!-- 個案詳細資料區（ReadOnly） -->
        @if (ViewBag.ShowCaseDetails == true && ViewBag.SelectedCase != null)
        {
            var viewModel = ViewBag.SelectedCase as CanLove_Backend.Domain.Case.ViewModels.Basic.CaseFormViewModel;
            <div class="card bg-white dark:bg-slate-900 rounded-xl shadow-card-lg border border-border dark:border-slate-800">
                <div class="px-6 py-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-slate-700">個案詳細資料</h3>
                        <button type="button" id="closeCaseDetails" class="btn btn--secondary">
                            <i class="bi bi-x-circle me-1"></i>關閉
                        </button>
                    </div>
                    <partial name="~/Views/Case/Basic/Partials/_CaseFormFields.cshtml" model="viewModel" />
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            const input = document.getElementById('basicSearchInput');
            const loading = document.getElementById('basicSearchLoading');
            const container = document.getElementById('basicSearchResults');
            const list = document.getElementById('basicResultsList');
            let timer;
            input.addEventListener('input', function(){
                clearTimeout(timer);
                const q = this.value.trim();
                if(!q){container.classList.add('d-none'); list.innerHTML=''; return;}
                loading.classList.remove('hidden');
                timer = setTimeout(async () => {
                    try{
                        const resp = await fetch(`/Case/SearchCases?query=${encodeURIComponent(q)}`);
                        const data = await resp.json();
                        loading.classList.add('hidden');
                        if(data.success && data.cases && data.cases.length){
                            container.classList.remove('d-none');
                            list.innerHTML = data.cases.map(c => `
                                <tr class="border-b border-border hover:bg-slate-50 cursor-pointer" onclick="viewCaseDetails('${escapeHtml(c.caseId||'')}')">
                                    <td><code>${escapeHtml(c.caseId||'')}</code></td>
                                    <td>${escapeHtml(c.name||'')}</td>
                                    <td>${escapeHtml(c.birthDate||'')}</td>
                                    <td>${escapeHtml(c.city||'')}</td>
                                    <td>${escapeHtml(c.district||'')}</td>
                                    <td>${escapeHtml(c.school||'')}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm" onclick="event.stopPropagation(); viewCaseDetails('${escapeHtml(c.caseId||'')}')">
                                            <i class="bi bi-eye me-1"></i>查看
                                        </button>
                                    </td>
                                </tr>`).join('');
                        }else{
                            container.classList.add('d-none'); list.innerHTML='';
                        }
                    }catch(e){
                        console.error(e); loading.classList.add('hidden');
                        container.classList.add('d-none'); list.innerHTML='';
                    }
                }, 400);
            });
            function escapeHtml(t){ if(!t) return ''; const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
            
            // 查看個案詳細資料
            function viewCaseDetails(caseId) {
                if (caseId) {
                    window.location.href = '@Url.Action("Query", "CaseBasic")?caseId=' + encodeURIComponent(caseId);
                }
            }
            
            // 關閉個案詳細資料
            const closeBtn = document.getElementById('closeCaseDetails');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    window.location.href = '@Url.Action("Query", "CaseBasic")';
                });
            }
            
            // 顯示全部個案按鈕
            const showAllBtn = document.getElementById('showAllCasesBtn');
            if (showAllBtn) {
                showAllBtn.addEventListener('click', function() {
                    window.location.href = '@Url.Action("Query", "CaseBasic")?showAll=true';
                });
            }
        })();
    </script>

    @if (ViewBag.ShowCaseDetails == true && ViewBag.SelectedCase != null)
{
    <script>
        // 載入已存在的照片（如果有 PhotoBlobId）
        (function() {
            const photoUrl = @Html.Raw(Json.Serialize(ViewBag.PhotoUrl));
            const photoBlobId = @Html.Raw(Json.Serialize(ViewBag.PhotoBlobId));
            
            // 使用函數確保 DOM 已載入
            function loadPhoto() {
                const photoPreviewContainer = document.getElementById('photoPreviewContainer');
                const photoPlaceholder = document.getElementById('photoPlaceholder');
                const photoLoadingContainer = document.getElementById('photoLoadingContainer');
                const previewImage = document.getElementById('previewImage');

                if (!photoPreviewContainer || !photoPlaceholder || !photoLoadingContainer || !previewImage) {
                    return;
                }

                if (photoUrl && photoUrl.trim() !== '') {
                    // 顯示載入動畫
                    photoPlaceholder.classList.add('hidden');
                    photoPreviewContainer.classList.add('hidden');
                    photoLoadingContainer.classList.remove('hidden');
                    
                    // 設置圖片載入成功和失敗的處理
                    previewImage.onload = function() {
                        // 隱藏載入動畫和 placeholder，顯示圖片
                        photoLoadingContainer.classList.add('hidden');
                        photoPlaceholder.classList.add('hidden');
                        photoPreviewContainer.classList.remove('hidden');
                    };
                    
                    previewImage.onerror = function() {
                        // 隱藏載入動畫和圖片，顯示 placeholder
                        photoLoadingContainer.classList.add('hidden');
                        photoPreviewContainer.classList.add('hidden');
                        photoPlaceholder.classList.remove('hidden');
                    };
                    
                    // 設置圖片來源（這會觸發載入）
                    previewImage.src = photoUrl;
                } else {
                    // 確保顯示 placeholder，隱藏其他元素
                    photoLoadingContainer.classList.add('hidden');
                    photoPreviewContainer.classList.add('hidden');
                    photoPlaceholder.classList.remove('hidden');
                }
            }

            // 確保 DOM 已載入
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(loadPhoto, 100);
                });
            } else {
                setTimeout(loadPhoto, 100);
            }
        })();

        // 載入地區資料
        (function() {
            const districtsByCity = @Html.Raw(Json.Serialize(ViewBag.DistrictsByCity));
            const citySelect = document.getElementById('citySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            function loadDistrictsForCity(cityId, preserveDistrictId = null) {
                if (!citySelect || !districtSelect) return;
                
                const cityIdKey = cityId ? parseInt(cityId) : null;
                
                if (preserveDistrictId === null) {
                    preserveDistrictId = districtSelect.value;
                }
                
                districtSelect.innerHTML = '<option value="">請選擇地區</option>';
                
                if (cityIdKey && districtsByCity[cityIdKey]) {
                    districtsByCity[cityIdKey].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.districtId;
                        option.textContent = district.districtName;
                        if (preserveDistrictId && preserveDistrictId == district.districtId) {
                            option.selected = true;
                        }
                        districtSelect.appendChild(option);
                    });
                    districtSelect.disabled = false;
                } else {
                    districtSelect.disabled = !cityIdKey;
                }
            }
            
            if (citySelect && districtSelect) {
                const selectedCityId = citySelect.value;
                const currentDistrictId = districtSelect.value || districtSelect.getAttribute('data-current-district-id');
                
                if (selectedCityId) {
                    const loadDistricts = () => {
                        loadDistrictsForCity(selectedCityId, currentDistrictId);
                    };
                    
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', function() {
                            setTimeout(loadDistricts, 200);
                        });
                    } else {
                        setTimeout(loadDistricts, 200);
                    }
                }
            }
        })();
    </script>
    }
}


