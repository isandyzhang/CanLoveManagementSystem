@model IEnumerable<CanLove_Backend.Data.Models.Core.Case>
@using Microsoft.AspNetCore.Authorization
@inject IAuthorizationService AuthorizationService

@{
    ViewData["Title"] = "個案管理";
    
    // 從 Microsoft Identity 標準的 role claim 讀取角色
    var userRoles = User.FindAll("http://schemas.microsoft.com/ws/2008/06/identity/claims/role").Select(c => c.Value).ToList();
    
    // 如果沒有找到，嘗試其他常見的 claim 名稱
    if (!userRoles.Any())
    {
        userRoles = User.FindAll("roles").Select(c => c.Value).ToList();
    }
    if (!userRoles.Any())
    {
        userRoles = User.FindAll("role").Select(c => c.Value).ToList();
    }
    
    var isAdmin = userRoles.Contains("admin") || User.IsInRole("admin");
    var isSocialWorker = userRoles.Contains("socialworker") || User.IsInRole("socialworker");
    var isAssistant = userRoles.Contains("assistant") || User.IsInRole("assistant");
    var isViewer = userRoles.Contains("viewer") || User.IsInRole("viewer");
}

<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
        <i class="bi bi-people"></i>個案管理
    </h2>
</div>


@if (Model.Any())
{
    <div class="card bg-white dark:bg-white rounded-xl shadow-card-lg border-0">
        <div class="p-4 bg-white text-slate-900">
            <div class="overflow-auto">
                <table class="data-table text-left">
                    <thead>
                        <tr>
                            <th>個案編號</th>
                            <th>姓名</th>
                            <th>性別</th>
                            <th>出生日期</th>
                            <th>學校</th>
                            <th>城市</th>
                            <th>審核狀態</th>
                            <th>建立者</th>
                            <th>建立時間</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <code>@item.CaseId</code>
                                </td>
                                <td>@item.Name</td>
                                <td>
                                    @if (item.Gender == "M" || item.Gender == "男")
                                    {
                                        <span class="badge-pill bg-primary text-white">男</span>
                                    }
                                    else if (item.Gender == "F" || item.Gender == "女")
                                    {
                                        <span class="badge-pill bg-secondary text-white">女</span>
                                    }
                                    else if (item.Gender == "O" || item.Gender == "其他")
                                    {
                                        <span class="badge-pill bg-muted">其他</span>
                                    }
                                    else
                                    {
                                        <span class="badge-pill bg-muted">未設定</span>
                                    }
                                </td>
                                <td>@item.BirthDate.ToTaiwanDateString()</td>
                                <td>@(item.School?.SchoolName ?? "未設定")</td>
                                <td>@(item.City?.CityName ?? "未設定")</td>
                                <td>
                                    @{
                                        var statusClass = ""; // map to Tailwind theme classes
                                        var statusText = "";
                                        var tooltipText = "";
                                        if (item.ReviewedAt != null)
                                        {
                                            statusClass = "bg-secondary text-white"; // 已審核
                                            statusText = "已審核";
                                            var reviewedBy = item.ReviewedBy ?? "系統";
                                            if (reviewedBy.Contains("@")) reviewedBy = reviewedBy.Split('@')[0];
                                            tooltipText = $"審核者：{reviewedBy} | {item.ReviewedAt:yyyy/MM/dd HH:mm}";
                                        }
                                        else if (item.SubmittedAt != null)
                                        {
                                            statusClass = "bg-primary text-white"; // 待審核
                                            statusText = "待審核";
                                            tooltipText = $"提交時間：{item.SubmittedAt:yyyy/MM/dd HH:mm}";
                                        }
                                        else
                                        {
                                            statusClass = "bg-muted"; // 草稿
                                            statusText = "草稿";
                                            tooltipText = "個案尚未提交審核";
                                        }
                                        if (item.IsLocked == true)
                                        {
                                            statusText += " 🔒";
                                            statusClass = "bg-primary text-white";
                                            var lockedBy = item.LockedBy ?? "系統";
                                            if (lockedBy.Contains("@")) lockedBy = lockedBy.Split('@')[0];
                                            tooltipText += $" | 鎖定者：{lockedBy} {item.LockedAt:yyyy/MM/dd HH:mm}";
                                        }
                                    }
                                    <span class="badge-pill @statusClass" title="@tooltipText">@statusText</span>
                                </td>
                                <td>
                                    @{
                                        var displayName = item.SubmittedBy ?? "系統";
                                        // 如果是 email 格式，取 @ 前面的部分
                                        if (displayName.Contains("@"))
                                        {
                                            displayName = displayName.Split('@')[0];
                                        }
                                    }
                                    <small class="text-slate-900">@displayName</small>
                                </td>
                                <td><datetime value="@item.CreatedAt"></datetime></td>
                                <td>
                                    <!-- 查看詳情移除 -->

                                    <!-- 編輯 - Admin 和 SocialWorker 都可以 -->
                                    @if (isAdmin || isSocialWorker)
                                    {
                                        <a href="@Url.Action("Step1", "CaseWizardOpenCase", new { caseId = item.CaseId })" 
                                           class="badge-pill me-1 bg-primary text-white"
                                           style="cursor: pointer;">
                                            編輯
                                        </a>
                                    }
                                    
                                    <!-- 提交審核 - Assistant 自己的草稿才能提交 -->
                                    @if (isAssistant && item.SubmittedAt == null)
                                    {
                                        <form method="post" action="@Url.Action("SubmitForReview", "Case", new { id = item.CaseId })" 
                                              style="display: inline;" onsubmit="return confirm('確定要提交此個案進行審核嗎？')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="badge-pill bg-primary text-white border-0" 
                                                    style="cursor: pointer;">
                                                提交審核
                                            </button>
                                        </form>
                                    }
                                    
                                    <!-- 審核按鈕 - SocialWorker 和 Admin 可以審核待審核的個案 -->
                                    @if ((isSocialWorker || isAdmin) && item.SubmittedAt != null && item.ReviewedAt == null)
                                    {
                                        <form method="post" action="@Url.Action("ReviewCase", "Case", new { id = item.CaseId, approved = true })" 
                                              style="display: inline;" onsubmit="return confirm('確定要通過此個案嗎？')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="badge-pill bg-secondary text-white border-0 me-1" 
                                                    style="cursor: pointer;">
                                                通過
                                            </button>
                                        </form>
                                        <form method="post" action="@Url.Action("ReviewCase", "Case", new { id = item.CaseId, approved = false })" 
                                              style="display: inline;" onsubmit="return confirm('確定要退回此個案嗎？')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="badge-pill bg-primary text-white border-0 me-1" 
                                                    style="cursor: pointer;">
                                                退回
                                            </button>
                                        </form>
                                    }
                                    
                                    <!-- 刪除 - 只有 Admin 可以 -->
                                    @if (isAdmin)
                                    {
                                        <a href="javascript:void(0)" 
                                           class="badge-pill bg-primary text-white me-1" 
                                           style="cursor: pointer;"
                                           onclick="deleteCase('@item.CaseId', '@item.Name')">
                                            刪除
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center py-10 text-slate-500">
        <i class="bi bi-inbox text-slate-400" style="font-size: 3rem;"></i>
        <h4 class="mt-3">尚無個案資料</h4>
        <p>目前沒有符合條件的個案記錄</p>
    </div>
}
