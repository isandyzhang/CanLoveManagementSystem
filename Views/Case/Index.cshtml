@model IEnumerable<CanLove_Backend.Data.Models.Core.Case>
@using Microsoft.AspNetCore.Authorization
@inject IAuthorizationService AuthorizationService

@{
    ViewData["Title"] = "å€‹æ¡ˆç®¡ç†";
    
    // å¾ Microsoft Identity æ¨™æº–çš„ role claim è®€å–è§’è‰²
    var userRoles = User.FindAll("http://schemas.microsoft.com/ws/2008/06/identity/claims/role").Select(c => c.Value).ToList();
    
    // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦å…¶ä»–å¸¸è¦‹çš„ claim åç¨±
    if (!userRoles.Any())
    {
        userRoles = User.FindAll("roles").Select(c => c.Value).ToList();
    }
    if (!userRoles.Any())
    {
        userRoles = User.FindAll("role").Select(c => c.Value).ToList();
    }
    
    var isAdmin = userRoles.Contains("admin") || User.IsInRole("admin");
    var isSocialWorker = userRoles.Contains("socialworker") || User.IsInRole("socialworker");
    var isAssistant = userRoles.Contains("assistant") || User.IsInRole("assistant");
    var isViewer = userRoles.Contains("viewer") || User.IsInRole("viewer");
}

<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
        <i class="bi bi-people"></i>å€‹æ¡ˆç®¡ç†
    </h2>
</div>


@if (Model.Any())
{
    <div class="card bg-white dark:bg-white rounded-xl shadow-card-lg border-0">
        <div class="p-4 bg-white text-slate-900">
            <div class="overflow-auto">
                <table class="data-table text-left">
                    <thead>
                        <tr>
                            <th>å€‹æ¡ˆç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>æ€§åˆ¥</th>
                            <th>å‡ºç”Ÿæ—¥æœŸ</th>
                            <th>å­¸æ ¡</th>
                            <th>åŸå¸‚</th>
                            <th>å¯©æ ¸ç‹€æ…‹</th>
                            <th>å»ºç«‹è€…</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <code>@item.CaseId</code>
                                </td>
                                <td>@item.Name</td>
                                <td>
                                    @if (item.Gender == "M" || item.Gender == "ç”·")
                                    {
                                        <span class="badge-pill bg-primary text-white">ç”·</span>
                                    }
                                    else if (item.Gender == "F" || item.Gender == "å¥³")
                                    {
                                        <span class="badge-pill bg-secondary text-white">å¥³</span>
                                    }
                                    else if (item.Gender == "O" || item.Gender == "å…¶ä»–")
                                    {
                                        <span class="badge-pill bg-muted">å…¶ä»–</span>
                                    }
                                    else
                                    {
                                        <span class="badge-pill bg-muted">æœªè¨­å®š</span>
                                    }
                                </td>
                                <td>@item.BirthDate.ToTaiwanDateString()</td>
                                <td>@(item.School?.SchoolName ?? "æœªè¨­å®š")</td>
                                <td>@(item.City?.CityName ?? "æœªè¨­å®š")</td>
                                <td>
                                    @{
                                        var statusClass = ""; // map to Tailwind theme classes
                                        var statusText = "";
                                        var tooltipText = "";
                                        if (item.ReviewedAt != null)
                                        {
                                            statusClass = "bg-secondary text-white"; // å·²å¯©æ ¸
                                            statusText = "å·²å¯©æ ¸";
                                            var reviewedBy = item.ReviewedBy ?? "ç³»çµ±";
                                            if (reviewedBy.Contains("@")) reviewedBy = reviewedBy.Split('@')[0];
                                            tooltipText = $"å¯©æ ¸è€…ï¼š{reviewedBy} | {item.ReviewedAt:yyyy/MM/dd HH:mm}";
                                        }
                                        else if (item.SubmittedAt != null)
                                        {
                                            statusClass = "bg-primary text-white"; // å¾…å¯©æ ¸
                                            statusText = "å¾…å¯©æ ¸";
                                            tooltipText = $"æäº¤æ™‚é–“ï¼š{item.SubmittedAt:yyyy/MM/dd HH:mm}";
                                        }
                                        else
                                        {
                                            statusClass = "bg-muted"; // è‰ç¨¿
                                            statusText = "è‰ç¨¿";
                                            tooltipText = "å€‹æ¡ˆå°šæœªæäº¤å¯©æ ¸";
                                        }
                                        if (item.IsLocked == true)
                                        {
                                            statusText += " ğŸ”’";
                                            statusClass = "bg-primary text-white";
                                            var lockedBy = item.LockedBy ?? "ç³»çµ±";
                                            if (lockedBy.Contains("@")) lockedBy = lockedBy.Split('@')[0];
                                            tooltipText += $" | é–å®šè€…ï¼š{lockedBy} {item.LockedAt:yyyy/MM/dd HH:mm}";
                                        }
                                    }
                                    <span class="badge-pill @statusClass" title="@tooltipText">@statusText</span>
                                </td>
                                <td>
                                    @{
                                        var displayName = item.SubmittedBy ?? "ç³»çµ±";
                                        // å¦‚æœæ˜¯ email æ ¼å¼ï¼Œå– @ å‰é¢çš„éƒ¨åˆ†
                                        if (displayName.Contains("@"))
                                        {
                                            displayName = displayName.Split('@')[0];
                                        }
                                    }
                                    <small class="text-slate-900">@displayName</small>
                                </td>
                                <td><datetime value="@item.CreatedAt"></datetime></td>
                                <td>
                                    <!-- æŸ¥çœ‹è©³æƒ…ç§»é™¤ -->

                                    <!-- ç·¨è¼¯ - Admin å’Œ SocialWorker éƒ½å¯ä»¥ -->
                                    @if (isAdmin || isSocialWorker)
                                    {
                                        <a href="@Url.Action("Step1", "CaseWizardOpenCase", new { caseId = item.CaseId })" 
                                           class="badge-pill me-1 bg-primary text-white"
                                           style="cursor: pointer;">
                                            ç·¨è¼¯
                                        </a>
                                    }
                                    
                                    <!-- æäº¤å¯©æ ¸ - Assistant è‡ªå·±çš„è‰ç¨¿æ‰èƒ½æäº¤ -->
                                    @if (isAssistant && item.SubmittedAt == null)
                                    {
                                        <form method="post" action="@Url.Action("SubmitForReview", "Case", new { id = item.CaseId })" 
                                              style="display: inline;" onsubmit="return confirm('ç¢ºå®šè¦æäº¤æ­¤å€‹æ¡ˆé€²è¡Œå¯©æ ¸å—ï¼Ÿ')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="badge-pill bg-primary text-white border-0" 
                                                    style="cursor: pointer;">
                                                æäº¤å¯©æ ¸
                                            </button>
                                        </form>
                                    }
                                    
                                    <!-- å¯©æ ¸æŒ‰éˆ• - SocialWorker å’Œ Admin å¯ä»¥å¯©æ ¸å¾…å¯©æ ¸çš„å€‹æ¡ˆ -->
                                    @if ((isSocialWorker || isAdmin) && item.SubmittedAt != null && item.ReviewedAt == null)
                                    {
                                        <form method="post" action="@Url.Action("ReviewCase", "Case", new { id = item.CaseId, approved = true })" 
                                              style="display: inline;" onsubmit="return confirm('ç¢ºå®šè¦é€šéæ­¤å€‹æ¡ˆå—ï¼Ÿ')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="badge-pill bg-secondary text-white border-0 me-1" 
                                                    style="cursor: pointer;">
                                                é€šé
                                            </button>
                                        </form>
                                        <form method="post" action="@Url.Action("ReviewCase", "Case", new { id = item.CaseId, approved = false })" 
                                              style="display: inline;" onsubmit="return confirm('ç¢ºå®šè¦é€€å›æ­¤å€‹æ¡ˆå—ï¼Ÿ')">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="badge-pill bg-primary text-white border-0 me-1" 
                                                    style="cursor: pointer;">
                                                é€€å›
                                            </button>
                                        </form>
                                    }
                                    
                                    <!-- åˆªé™¤ - åªæœ‰ Admin å¯ä»¥ -->
                                    @if (isAdmin)
                                    {
                                        <a href="javascript:void(0)" 
                                           class="badge-pill bg-primary text-white me-1" 
                                           style="cursor: pointer;"
                                           onclick="deleteCase('@item.CaseId', '@item.Name')">
                                            åˆªé™¤
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center py-10 text-slate-500">
        <i class="bi bi-inbox text-slate-400" style="font-size: 3rem;"></i>
        <h4 class="mt-3">å°šç„¡å€‹æ¡ˆè³‡æ–™</h4>
        <p>ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å€‹æ¡ˆè¨˜éŒ„</p>
    </div>
}
