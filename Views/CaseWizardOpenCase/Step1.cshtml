@model CanLove_Backend.Models.Mvc.ViewModels.CaseWizardOpenCase.CaseWizard_S1_CD_ViewModel

@{
    ViewData["Title"] = "開案記錄表";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // 自訂麵包屑：首頁 > 個案管理 > 新增個案 > 開案記錄表
    ViewData["Breadcrumbs"] = new List<(string Text, string Url)>
    {
        ("個案管理", Url.Action("Index", "Case") ?? string.Empty),
        ("新增個案", Url.Action("Create", "Case") ?? string.Empty),
        ("開案記錄表", string.Empty)
    };
}

<div class="w-full px-4 sm:px-6 lg:px-8">
    <div class="max-w-[1400px] mx-auto">
        <div class="w-full">

            @{ ViewBag.CurrentPage = "Create"; ViewBag.CurrentTab = "CaseOpening"; }
            <partial name="~/Views/Case/Partials/_CaseTabs.cshtml" />

            @{
                ViewBag.CurrentStep = 1;
                ViewBag.CaseId = Model.CaseId;
                var hasCaseId = !string.IsNullOrEmpty(Model.CaseId);
            }
            
            <!-- 如果沒有選擇個案，顯示選擇個案區塊 -->
            @if (!hasCaseId)
            {
                <div class="row justify-content-center mb-4">
                    <div class="col-lg-8">
                        <div class="card bg-white dark:bg-white rounded-xl shadow-card-lg border rounded-xl border-[#FDBA74]">
                            <div class="px-6 py-4 rounded-t-xl bg-[#FFF1E6]">
                                <h5 class="mb-0 text-slate-900">
                                    <i class="bi bi-person-plus me-1"></i>請先選擇個案
                                </h5>
                            </div>
                            <div class="px-6 py-6">
                                <p class="text-slate-600 dark:text-slate-400 mb-4">請輸入個案編號、姓名或電話號碼進行搜尋</p>
                                
                                <!-- 搜尋輸入框 -->
                                <div class="mb-4">
                                    <label for="caseSearchInput" class="block text-sm text-slate-700 mb-1">搜尋個案</label>
                                    <div class="flex">
                                        <span class="inline-flex items-center px-3 border border-r-0 border-border rounded-l-md bg-slate-50 text-slate-500"><i class="fas fa-search"></i></span>
                                        <input type="text" id="caseSearchInput" class="input flex-1 rounded-l-none" placeholder="請輸入個案編號、姓名或電話號碼..." autocomplete="off" />
                                        <span id="caseSearchLoading" class="hidden items-center px-3 border border-l-0 border-border rounded-r-md"><span class="spinner-border spinner-border-sm" role="status"></span></span>
                                    </div>
                                </div>

                                <!-- 搜尋結果（表格樣式，對齊個案審核列表） -->
                                <div id="caseSearchResults" class="d-none">
                                    <div class="card bg-white rounded-xl border border-border shadow-sm">
                                        <div class="p-3 pb-0">
                                            <h6 class="text-slate-900 mb-2">搜尋結果</h6>
                                        </div>
                                        <div class="p-3 pt-0 overflow-auto">
                                            <table class="data-table text-left w-full text-slate-900">
                                                <thead>
                                                    <tr class="bg-slate-50">
                                                        <th class="text-slate-700">姓名</th>
                                                        <th class="text-slate-700">出生日期</th>
                                                        <th class="text-slate-700">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="caseResultsList">
                                                    <!-- 動態插入 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- 移除多餘提示，保持乾淨介面 -->
                            </div>
                        </div>
                    </div>
                </div>
            }
            
            <!-- 導航分頁和進度條（只在有 caseId 時顯示） -->
            @if (hasCaseId)
            {
                @await Html.PartialAsync("~/Views/CaseWizardOpenCase/_WizardNavigation.cshtml")
            }

            <!-- 表單（只在有 caseId 時顯示） -->
            @if (hasCaseId)
            {
            <form asp-action="Step1" method="post" class="needs-validation" novalidate>
                <div class="card bg-white dark:bg-white rounded-xl shadow-card-lg border rounded-xl border-[#FDBA74]">
                    <div class="px-6 py-4 mb-5 flex items-center justify-between bg-[#FFF1E6] rounded-t-xl">
                        <span class="inline-flex items-center gap-3 text-2xl font-bold text-slate-800">
                            <i class="bi bi-card-text"></i>
                            個案詳細資料
                        </span>
                    </div>
                    <div class="px-6 py-6">
                                <!-- 隱藏欄位 -->
                                <input asp-for="CaseId" type="hidden" />

                                <!-- 聯絡人資訊 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary border-b border-border pb-2 mb-3">
                                            <i class="fas fa-phone me-2"></i>聯絡人資訊
                                        </h6>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label asp-for="ContactName" class="block text-lg font-medium mb-2 text-slate-900">聯絡人姓名 <small class="block text-slate-500">contact_name（可空，NVARCHAR(20)）</small></label>
                                            <input asp-for="ContactName" class="input" placeholder="請輸入聯絡人姓名" />
                                            <span asp-validation-for="ContactName" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="ContactRelationValueId" class="block text-lg font-medium mb-2 text-slate-900">與案主關係 <small class="block text-slate-500">contact_relation_value_id（可空，外鍵 OptionSetValues.value_id）</small></label>
                                            <select asp-for="ContactRelationValueId" class="input">
                                                <option value="">請選擇關係</option>
                                                @if (Model.ContactRelationOptions != null)
                                                {
                                                    @foreach (var option in Model.ContactRelationOptions)
                                                    {
                                                        <option value="@option.OptionValueId">@option.ValueName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="ContactRelationValueId" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="ContactPhone" class="block text-lg font-medium mb-2 text-slate-900">聯絡人電話 <small class="block text-slate-500">contact_phone（可空，NVARCHAR(15)）</small></label>
                                            <input asp-for="ContactPhone" class="input" placeholder="請輸入聯絡人電話" />
                                            <span asp-validation-for="ContactPhone" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="HomePhone" class="block text-lg font-medium mb-2 text-slate-900">住家電話 <small class="block text-slate-500">home_phone（可空，NVARCHAR(15)）</small></label>
                                            <input asp-for="HomePhone" class="input" placeholder="請輸入住家電話" />
                                            <span asp-validation-for="HomePhone" class="text-red-600 text-sm"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 家庭結構 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary border-b border-border pb-2 mb-3">
                                            <i class="fas fa-home me-2"></i>家庭結構
                                        </h6>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label asp-for="FamilyStructureTypeId" class="block text-lg font-medium mb-2 text-slate-900">家庭結構類型 <small class="block text-slate-500">family_structure_type_id（可空，外鍵 FamilyStructureTypes.family_structure_type_id）</small></label>
                                            <select asp-for="FamilyStructureTypeId" class="input" id="familyStructureSelect">
                                                <option value="">請選擇家庭結構類型</option>
                                                @if (Model.FamilyStructureTypeOptions != null)
                                                {
                                                    @foreach (var option in Model.FamilyStructureTypeOptions)
                                                    {
                                                        <option value="@option.StructureTypeId">@option.StructureName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="FamilyStructureTypeId" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="FamilyStructureOtherDesc" class="block text-lg font-medium mb-2 text-slate-900">其他結構描述 <small class="block text-slate-500">family_structure_other_desc（可空，NVARCHAR(100)）</small></label>
                                            <input asp-for="FamilyStructureOtherDesc" class="input" placeholder="請描述其他家庭結構類型" />
                                            <span asp-validation-for="FamilyStructureOtherDesc" class="text-red-600 text-sm"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 父母國籍 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary border-b border-border pb-2 mb-3">
                                            <i class="fas fa-globe me-2"></i>父母國籍
                                        </h6>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label asp-for="ParentNationFatherId" class="block text-lg font-medium mb-2 text-slate-900">父親國籍 <small class="block text-slate-500">parent_nation_father_id（可空，外鍵 Nationalities.nationality_id）</small></label>
                                            <select asp-for="ParentNationFatherId" class="input">
                                                <option value="">請選擇父親國籍</option>
                                                @if (Model.NationalityOptions != null)
                                                {
                                                    @foreach (var option in Model.NationalityOptions)
                                                    {
                                                        <option value="@option.NationalityId">@option.NationalityName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="ParentNationFatherId" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="ParentNationMotherId" class="block text-lg font-medium mb-2 text-slate-900">母親國籍 <small class="block text-slate-500">parent_nation_mother_id（可空，外鍵 Nationalities.nationality_id）</small></label>
                                            <select asp-for="ParentNationMotherId" class="input">
                                                <option value="">請選擇母親國籍</option>
                                                @if (Model.NationalityOptions != null)
                                                {
                                                    @foreach (var option in Model.NationalityOptions)
                                                    {
                                                        <option value="@option.NationalityId">@option.NationalityName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="ParentNationMotherId" class="text-red-600 text-sm"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 主要照顧者資訊 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary border-b border-border pb-2 mb-3">
                                            <i class="fas fa-user-tie me-2"></i>主要照顧者資訊
                                        </h6>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label asp-for="MainCaregiverName" class="block text-lg font-medium mb-2 text-slate-900">主要照顧者姓名 <small class="block text-slate-500">main_caregiver_name（可空，NVARCHAR(20)）</small></label>
                                            <input asp-for="MainCaregiverName" class="input" placeholder="請輸入主要照顧者姓名" />
                                            <span asp-validation-for="MainCaregiverName" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="MainCaregiverRelationValueId" class="block text-lg font-medium mb-2 text-slate-900">與案主關係 <small class="block text-slate-500">main_caregiver_relation_value_id（可空，INT）</small></label>
                                            <select asp-for="MainCaregiverRelationValueId" class="input" asp-items="@(new SelectList(Model.MainCaregiverRelationOptions, "OptionValueId", "ValueName", Model.MainCaregiverRelationValueId))">
                                                <option value="">請選擇與案主關係</option>
                                            </select>
                                            <span asp-validation-for="MainCaregiverRelationValueId" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="MainCaregiverId" class="block text-lg font-medium mb-2 text-slate-900">身分證字號(加密) <small class="block text-slate-500">main_caregiver_id（可空，NVARCHAR(255)）</small></label>
                                            <input asp-for="MainCaregiverId" class="input" placeholder="請輸入身分證字號" />
                                            <span asp-validation-for="MainCaregiverId" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="MainCaregiverBirth" class="block text-lg font-medium mb-2 text-slate-900">生日 <small class="block text-slate-500">main_caregiver_birth（可空，DATE）</small></label>
                                            <input asp-for="MainCaregiverBirth" type="date" class="input" />
                                            <span asp-validation-for="MainCaregiverBirth" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="MainCaregiverJob" class="block text-lg font-medium mb-2 text-slate-900">職業 <small class="block text-slate-500">main_caregiver_job（可空，NVARCHAR(30)）</small></label>
                                            <input asp-for="MainCaregiverJob" class="input" placeholder="請輸入職業" />
                                            <span asp-validation-for="MainCaregiverJob" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="MainCaregiverMarryStatusValueId" class="block text-lg font-medium mb-2 text-slate-900">婚姻狀況 <small class="block text-slate-500">main_caregiver_marry_status_value_id（可空，外鍵 OptionSetValues.value_id）</small></label>
                                            <select asp-for="MainCaregiverMarryStatusValueId" class="input">
                                                <option value="">請選擇婚姻狀況</option>
                                                @if (Model.MarryStatusOptions != null)
                                                {
                                                    @foreach (var option in Model.MarryStatusOptions)
                                                    {
                                                        <option value="@option.OptionValueId">@option.ValueName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="MainCaregiverMarryStatusValueId" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="MainCaregiverEduValueId" class="block text-lg font-medium mb-2 text-slate-900">教育程度 <small class="block text-slate-500">main_caregiver_edu_value_id（可空，外鍵 OptionSetValues.value_id）</small></label>
                                            <select asp-for="MainCaregiverEduValueId" class="input">
                                                <option value="">請選擇教育程度</option>
                                                @if (Model.EducationLevelOptions != null)
                                                {
                                                    @foreach (var option in Model.EducationLevelOptions)
                                                    {
                                                        <option value="@option.OptionValueId">@option.ValueName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="MainCaregiverEduValueId" class="text-red-600 text-sm"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 個案來源與經驗 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary border-b border-border pb-2 mb-3">
                                            <i class="fas fa-info-circle me-2"></i>個案來源與經驗
                                        </h6>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label asp-for="SourceValueId" class="block text-lg font-medium mb-2 text-slate-900">個案來源 <small class="block text-slate-500">source_value_id（可空，外鍵 OptionSetValues.value_id）</small></label>
                                            <select asp-for="SourceValueId" class="input">
                                                <option value="">請選擇個案來源</option>
                                                @if (Model.SourceOptions != null)
                                                {
                                                    @foreach (var option in Model.SourceOptions)
                                                    {
                                                        <option value="@option.OptionValueId">@option.ValueName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="SourceValueId" class="text-red-600 text-sm"></span>
                                        </div>
                                        <div>
                                            <label asp-for="HelpExperienceValueId" class="block text-lg font-medium mb-2 text-slate-900">求助經驗 <small class="block text-slate-500">help_experience_value_id（可空，外鍵 OptionSetValues.value_id）</small></label>
                                            <select asp-for="HelpExperienceValueId" class="input">
                                                <option value="">請選擇求助經驗</option>
                                                @if (Model.HelpExperienceOptions != null)
                                                {
                                                    @foreach (var option in Model.HelpExperienceOptions)
                                                    {
                                                        <option value="@option.OptionValueId">@option.ValueName</option>
                                                    }
                                                }
                                            </select>
                                            <span asp-validation-for="HelpExperienceValueId" class="text-red-600 text-sm"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 備註 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="text-primary border-b border-border pb-2 mb-3">
                                            <i class="fas fa-sticky-note me-2"></i>備註
                                        </h6>
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label asp-for="Note" class="block text-lg font-medium mb-2 text-slate-900">備註 <small class="block text-slate-500">note（可空，NVARCHAR(1000)）</small></label>
                                            <textarea asp-for="Note" class="input" rows="4" placeholder="請輸入備註資訊"></textarea>
                                            <span asp-validation-for="Note" class="text-red-600 text-sm"></span>
                                        </div>
                                    </div>
                                </div>

                                <partial name="~/Views/CaseWizardOpenCase/Partials/_CaseWizardFormActions.cshtml" model="Model" />
                    </div>
                </div>
            </form>
            }
        </div>
    </div>
</div>

@section Scripts {
    @if (!hasCaseId)
    {
    <script>
        // 個案搜尋功能
        (function() {
            const searchInput = document.getElementById('caseSearchInput');
            const searchResults = document.getElementById('caseSearchResults');
            const resultsList = document.getElementById('caseResultsList');
            const searchLoading = document.getElementById('caseSearchLoading');

            let searchTimeout;

            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                // 清除之前的延遲
                clearTimeout(searchTimeout);

                // 如果輸入為空，清空並隱藏結果
                if (query === '') {
                    hideAll();
                    return;
                }

                // 顯示載入中
                searchLoading.classList.remove('d-none');

                // 設定延遲搜尋（防抖，500ms）
                searchTimeout = setTimeout(async function() {
                    try {
                        const response = await fetch(`/Case/SearchCases?query=${encodeURIComponent(query)}`);
                        const data = await response.json();

                        searchLoading.classList.add('d-none');

                        if (data.success && data.cases && data.cases.length > 0) {
                            displayResults(data.cases);
                        } else {
                            hideAll();
                        }
                    } catch (error) {
                        console.error('搜尋失敗:', error);
                        searchLoading.classList.add('d-none');
                        hideAll();
                        alert('搜尋時發生錯誤，請稍後再試');
                    }
                }, 500);
            });

            function displayResults(cases) {
                hideAll();
                searchResults.classList.remove('d-none');

                // 表格列渲染：姓名 / 出生日期 / 操作
                resultsList.innerHTML = cases.map(c => `
                    <tr class="border-b border-border">
                        <td class="text-slate-900">
                            <span class="fw-semibold">${escapeHtml(c.name || '')}</span>
                        </td>
                        <td class="text-slate-900">${c.birthDate ? escapeHtml(c.birthDate) : ''}</td>
                        <td>
                            <a class="badge-pill bg-primary text-white" href="/CaseWizardOpenCase/Step1?caseId=${encodeURIComponent(c.caseId)}">選擇</a>
                        </td>
                    </tr>
                `).join('');
            }

            function hideAll() {
                searchResults.classList.add('d-none');
                resultsList.innerHTML = '';
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // 初始聚焦到搜尋框
            searchInput.focus();
        })();
    </script>
    }
    <script>
        // 表單驗證
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // 家庭結構類型選擇時顯示/隱藏其他描述欄位
        document.getElementById('familyStructureSelect').addEventListener('change', function() {
            const otherDescField = document.querySelector('input[name="FamilyStructureOtherDesc"]');
            const otherDescContainer = otherDescField.closest('.col-md-6');
            
            if (this.value) {
                // 檢查是否選擇了"其他"選項（假設最後一個選項是"其他"）
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.textContent.includes('其他') || selectedOption.textContent.includes('Other')) {
                    otherDescContainer.style.display = 'block';
                    otherDescField.required = true;
                } else {
                    otherDescContainer.style.display = 'block';
                    otherDescField.required = false;
                    otherDescField.value = '';
                }
            } else {
                otherDescContainer.style.display = 'none';
                otherDescField.required = false;
                otherDescField.value = '';
            }
        });

        // 初始化時檢查家庭結構類型
        document.addEventListener('DOMContentLoaded', function() {
            const familyStructureSelect = document.getElementById('familyStructureSelect');
            if (familyStructureSelect.value) {
                familyStructureSelect.dispatchEvent(new Event('change'));
            }
        });
    </script>
}
