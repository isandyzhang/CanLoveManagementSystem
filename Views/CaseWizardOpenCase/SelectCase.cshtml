@{
    ViewData["Title"] = "開案紀錄表";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Breadcrumbs"] = new List<(string Text, string Url)>
    {
        ("個案管理", Url.Action("Index", "Case") ?? string.Empty),
        ("新增個案", Url.Action("Create", "Case") ?? string.Empty),
        ("開案紀錄表", string.Empty)
    };
}

<div class="w-full px-4 sm:px-6 lg:px-8">
    <div class="max-w-[1400px] mx-auto">
        <div class="w-full">
            @{ ViewBag.CurrentPage = "Create"; ViewBag.CurrentTab = "CaseOpening"; }
            <partial name="~/Views/Case/Partials/_CaseTabs.cshtml" />
            <div class="card bg-white dark:bg-white shadow-card-lg border rounded-xl border-[#FDBA74] mt-3">
                <div class="px-6 py-4 rounded-t-xl bg-[#FFF1E6]">
                    <h5 class="mb-0 text-slate-900">
                        <i class="bi bi-card-text me-2"></i>選擇個案
                    </h5>
                </div>
                <div class="px-6 py-6">
                    <div class="mb-4">
                        <label for="caseSearchInput" class="block text-sm text-slate-700 mb-1">搜尋個案（編號/姓名/電話）</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 border border-r-0 border-border rounded-l-md bg-slate-50 text-slate-500"><i class="fas fa-search"></i></span>
                            <input type="text" id="caseSearchInput" class="input flex-1 rounded-l-none" placeholder="請輸入關鍵字..." autocomplete="off" />
                            <span id="caseSearchLoading" class="hidden items-center px-3 border border-l-0 border-border rounded-r-md"><span class="spinner-border spinner-border-sm" role="status"></span></span>
                        </div>
                    </div>

                    <div id="caseSearchResults" class="d-none">
                        <div class="overflow-auto">
                            <table class="data-table text-left w-full text-slate-900">
                                <thead>
                                    <tr class="bg-slate-50">
                                        <th class="text-slate-700">個案編號</th>
                                        <th class="text-slate-700">姓名</th>
                                        <th class="text-slate-700">出生日期</th>
                                        <th class="text-slate-700">城市</th>
                                        <th class="text-slate-700">地區</th>
                                        <th class="text-slate-700">學校</th>
                                        <th class="text-slate-700">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="caseResultsList">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function(){
    const searchInput = document.getElementById('caseSearchInput');
    const searchResults = document.getElementById('caseSearchResults');
    const resultsList = document.getElementById('caseResultsList');
    const searchLoading = document.getElementById('caseSearchLoading');
    let searchTimeout;

    searchInput.addEventListener('input', function(){
        const query = this.value.trim();
        clearTimeout(searchTimeout);
        if(query === ''){
            hideResults();
            return;
        }
        searchLoading.classList.remove('hidden');
        searchTimeout = setTimeout(async () => {
            try {
                const res = await fetch(`/Case/SearchCases?query=${encodeURIComponent(query)}`);
                const data = await res.json();
                searchLoading.classList.add('hidden');
                if(data.success && data.cases && data.cases.length){
                    render(data.cases);
                } else {
                    hideResults();
                }
            } catch(e){
                console.error(e);
                searchLoading.classList.add('hidden');
                hideResults();
            }
        }, 400);
    });

    function render(cases){
        searchResults.classList.remove('d-none');
        resultsList.innerHTML = cases.map(c => `
            <tr class="border-b border-border hover:bg-slate-50 cursor-pointer" data-id="${escapeHtml(c.caseId)}">
                <td class="text-slate-900"><code>${escapeHtml(c.caseId || '')}</code></td>
                <td class="text-slate-900">${escapeHtml(c.name || '')}</td>
                <td class="text-slate-900">${escapeHtml(c.birthDate || '')}</td>
                <td class="text-slate-900">${escapeHtml(c.city || '')}</td>
                <td class="text-slate-900">${escapeHtml(c.district || '')}</td>
                <td class="text-slate-900">${escapeHtml(c.school || '')}</td>
                <td>
                    <a href="/CaseWizardOpenCase/Step1?caseId=${encodeURIComponent(c.caseId)}" class="badge-pill bg-primary text-white">
                        <i class="bi bi-pencil me-1"></i>寫開案記錄
                    </a>
                </td>
            </tr>
        `).join('');
    }

    function hideResults(){
        searchResults.classList.add('d-none');
        resultsList.innerHTML = '';
    }

    function escapeHtml(text){
        if(!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    searchInput.focus();
})();
</script>
}


