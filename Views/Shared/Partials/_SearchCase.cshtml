@{
    // 參數：mode (Create/ReadOnly/ReviewEdit), targetAction, targetController, targetStep, autoLoad (是否預設載入全部)
    var mode = ViewBag.Mode as string ?? "Create";
    var targetAction = ViewBag.TargetAction as string ?? "Create";
    var targetController = ViewBag.TargetController as string ?? "CaseOpening";
    var targetStep = ViewBag.TargetStep as string ?? "CaseDetail";
    var autoLoad = ViewBag.AutoLoad as bool? ?? false;
    
    // 根據 mode 決定按鈕文字
    var buttonText = mode == "ReadOnly" ? "查看" : mode == "ReviewEdit" ? "審核" : "選擇";
    var buttonClass = mode == "ReadOnly" ? "bg-blue-400 hover:bg-blue-500" : 
                      mode == "ReviewEdit" ? "bg-purple-400 hover:bg-purple-500" : 
                      "bg-orange-400 hover:bg-orange-500";
}

<div class="mb-4">
    <label for="searchCaseInput" class="block text-sm text-slate-700 dark:text-slate-300 mb-1">搜尋個案（編號/姓名/電話）</label>
    <div class="flex">
        <span class="inline-flex items-center px-3 border border-r-0 border-border dark:border-slate-700 rounded-l-md bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400">
            <i class="bi bi-search"></i>
        </span>
        <input 
            type="text" 
            id="searchCaseInput" 
            class="input flex-1 rounded-l-none focus:ring-orange-400 focus:border-orange-400 dark:bg-slate-800 dark:text-slate-100" 
            placeholder="請輸入關鍵字..." 
            autocomplete="off" />
        <span id="searchCaseLoading" class="hidden items-center px-3 border border-l-0 border-border dark:border-slate-700 rounded-r-md bg-slate-50 dark:bg-slate-800">
            <span class="spinner-border spinner-border-sm" role="status"></span>
        </span>
    </div>
</div>

<div id="searchCaseResults" class="hidden">
    <div class="overflow-auto">
        <table class="data-table text-left w-full text-slate-900 dark:text-slate-100">
            <thead>
                <tr class="bg-slate-50 dark:bg-slate-800">
                    <th class="text-slate-700 dark:text-slate-300">個案編號</th>
                    <th class="text-slate-700 dark:text-slate-300">姓名</th>
                    <th class="text-slate-700 dark:text-slate-300">出生日期</th>
                    <th class="text-slate-700 dark:text-slate-300">城市</th>
                    <th class="text-slate-700 dark:text-slate-300">地區</th>
                    <th class="text-slate-700 dark:text-slate-300">學校</th>
                    <th class="text-slate-700 dark:text-slate-300">操作</th>
                </tr>
            </thead>
            <tbody id="searchCaseResultsList"></tbody>
        </table>
    </div>
</div>

<script>
(function(){
    const searchInput = document.getElementById('searchCaseInput');
    const searchResults = document.getElementById('searchCaseResults');
    const resultsList = document.getElementById('searchCaseResultsList');
    const searchLoading = document.getElementById('searchCaseLoading');
    let searchTimeout;

    const mode = '@mode';
    const targetAction = '@targetAction';
    const targetController = '@targetController';
    const targetStep = '@targetStep';
    const autoLoad = @(autoLoad ? "true" : "false");
    
    // 根據 mode 決定按鈕文字和連結
    const buttonText = mode === 'ReadOnly' ? '查看' : mode === 'ReviewEdit' ? '審核' : '選擇';
    const buttonClass = mode === 'ReadOnly' ? 'bg-blue-400 hover:bg-blue-500' : 
                        mode === 'ReviewEdit' ? 'bg-purple-400 hover:bg-purple-500' : 
                        'bg-orange-400 hover:bg-orange-500';
    
    // 建立連結 URL
    function buildUrl(caseId) {
        let url;
        // 如果 targetAction 是 Create，使用新的路由格式 /Create/{step}
        if (targetAction === 'Create' && targetStep) {
            url = `/${targetController}/${targetAction}/${targetStep}?caseId=${encodeURIComponent(caseId)}`;
        } else {
            url = `/${targetController}/${targetAction}?caseId=${encodeURIComponent(caseId)}`;
        }
        if (mode !== 'Create') {
            url += `&mode=${mode}`;
        }
        return url;
    }

    function performSearch(query) {
        clearTimeout(searchTimeout);
        
        if (query === '') {
            if (!autoLoad) {
                hideResults();
                return;
            }
            // autoLoad 模式下，空查詢也要執行
        }
        
        searchLoading.classList.remove('hidden');
        searchTimeout = setTimeout(async () => {
            try {
                const url = query === '' && autoLoad 
                    ? '/Case/SearchCases' 
                    : `/Case/SearchCases?query=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                const data = await res.json();
                searchLoading.classList.add('hidden');
                if (data.success && data.cases && data.cases.length) {
                    render(data.cases);
                } else {
                    hideResults();
                }
            } catch(e) {
                console.error(e);
                searchLoading.classList.add('hidden');
                hideResults();
            }
        }, 400);
    }

    searchInput.addEventListener('input', function(){
        const query = this.value.trim();
        performSearch(query);
    });

    function render(cases){
        searchResults.classList.remove('hidden');
        resultsList.innerHTML = cases.map(c => `
            <tr class="border-b border-border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer">
                <td class="text-slate-900 dark:text-slate-100">
                    <code class="text-sm">${escapeHtml(c.caseId || '')}</code>
                </td>
                <td class="text-slate-900 dark:text-slate-100">${escapeHtml(c.name || '')}</td>
                <td class="text-slate-900 dark:text-slate-100">${escapeHtml(c.birthDate || '')}</td>
                <td class="text-slate-900 dark:text-slate-100">${escapeHtml(c.city || '')}</td>
                <td class="text-slate-900 dark:text-slate-100">${escapeHtml(c.district || '')}</td>
                <td class="text-slate-900 dark:text-slate-100">${escapeHtml(c.school || '')}</td>
                <td>
                    <a href="${buildUrl(c.caseId)}" class="badge-pill text-white ${buttonClass}">
                        <i class="bi ${mode === 'ReadOnly' ? 'bi-eye' : mode === 'ReviewEdit' ? 'bi-check-circle' : 'bi-pencil'} me-1"></i>${buttonText}
                    </a>
                </td>
            </tr>
        `).join('');
    }

    function hideResults(){
        searchResults.classList.add('hidden');
        resultsList.innerHTML = '';
    }

    function escapeHtml(text){
        if(!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 如果 autoLoad 為 true，頁面載入時自動執行空查詢
    if (autoLoad) {
        // 等待 DOM 完全載入後執行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                performSearch('');
            });
        } else {
            performSearch('');
        }
    }

    searchInput.focus();
})();
</script>

