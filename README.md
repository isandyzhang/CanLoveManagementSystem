# CanLove å€‹æ¡ˆç®¡ç†ç³»çµ±å¾Œç«¯

[![.NET](https://img.shields.io/badge/.NET-9.0-512BD4?logo=dotnet)](https://dotnet.microsoft.com/)
[![ASP.NET Core](https://img.shields.io/badge/ASP.NET%20Core-9.0-512BD4?logo=asp.net)](https://dotnet.microsoft.com/apps/aspnet)
[![Entity Framework Core](https://img.shields.io/badge/EF%20Core-9.0-512BD4?logo=entity-framework)](https://docs.microsoft.com/ef/core/)
[![Azure](https://img.shields.io/badge/Azure-Cloud-0078D4?logo=microsoft-azure)](https://azure.microsoft.com/)

CanLove å€‹æ¡ˆç®¡ç†ç³»çµ±æ˜¯ä¸€å€‹å°ˆç‚ºéæ”¿åºœçµ„ç¹”ï¼ˆNGOï¼‰è¨­è¨ˆçš„å¾Œç«¯æ‡‰ç”¨ç¨‹å¼ï¼Œç”¨æ–¼ç®¡ç†å€‹æ¡ˆè³‡æ–™ã€å“¡å·¥è³‡è¨Šã€å‡ºå‹¤è¨˜éŒ„å’Œç‰©è³‡ç®¡ç†ç­‰æ ¸å¿ƒæ¥­å‹™åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®éŒ„

- [åŠŸèƒ½ç‰¹è‰²](#åŠŸèƒ½ç‰¹è‰²)
- [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
- [ç³»çµ±éœ€æ±‚](#ç³»çµ±éœ€æ±‚)
- [å¿«é€Ÿé–‹å§‹](#å¿«é€Ÿé–‹å§‹)
- [å°ˆæ¡ˆçµæ§‹](#å°ˆæ¡ˆçµæ§‹)
- [ç’°å¢ƒè¨­å®š](#ç’°å¢ƒè¨­å®š)
- [é–‹ç™¼æŒ‡å—](#é–‹ç™¼æŒ‡å—)
- [éƒ¨ç½²èªªæ˜](#éƒ¨ç½²èªªæ˜)
- [æˆæ¬Š](#æˆæ¬Š)

## âœ¨ åŠŸèƒ½ç‰¹è‰²

### æ ¸å¿ƒæ¨¡çµ„

- **å€‹æ¡ˆç®¡ç†ï¼ˆCase Managementï¼‰**
  - å€‹æ¡ˆåŸºæœ¬è³‡æ–™ç®¡ç†
  - é–‹æ¡ˆæµç¨‹ï¼ˆ7 æ­¥é©Ÿç²¾éˆå¼æµç¨‹ï¼‰
    - å€‹æ¡ˆè©³ç´°è³‡æ–™
    - ç¤¾æœƒå·¥ä½œæœå‹™å…§å®¹
    - ç¶“æ¿Ÿç‹€æ³è©•ä¼°
    - å¥åº·ç‹€æ³è©•ä¼°
    - å­¸æ¥­è¡¨ç¾è©•ä¼°
    - æƒ…ç·’è©•ä¼°
    - æœ€å¾Œè©•ä¼°è¡¨
  - é—œæ‡·è¨ªè¦–è¨˜éŒ„è¡¨
  - æœƒè«‡æœå‹™ç´€éŒ„è¡¨
  - å¯©æ ¸åŠŸèƒ½

- **å“¡å·¥ç®¡ç†ï¼ˆStaff Managementï¼‰**
  - å“¡å·¥è³‡æ–™ç¶­è­·
  - æ¬Šé™ç®¡ç†

- **å‡ºå‹¤ç®¡ç†ï¼ˆAttendance Managementï¼‰**
  - å‡ºå‹¤è¨˜éŒ„è¿½è¹¤

- **ç‰©è³‡ç®¡ç†ï¼ˆSupply Managementï¼‰**
  - ç‰©è³‡åº«å­˜ç®¡ç†

### å®‰å…¨åŠŸèƒ½

- **Azure AD æ•´åˆèªè­‰**
  - OpenID Connect å–®ä¸€ç™»å…¥ï¼ˆSSOï¼‰
  - Microsoft Identity Web æ•´åˆ
  - Cookie åŸºç¤æœƒè©±ç®¡ç†

- **è³‡æ–™ä¿è­·**
  - æ•æ„Ÿè³‡æ–™åŠ å¯†ï¼ˆå¦‚èº«åˆ†è­‰å­—è™Ÿï¼‰
  - Data Protection API é‡‘é‘°æŒä¹…åŒ–
  - Azure Key Vault æ•´åˆï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

- **æˆæ¬Šæ©Ÿåˆ¶**
  - åŸºæ–¼è§’è‰²çš„å­˜å–æ§åˆ¶ï¼ˆRBACï¼‰
  - æ¬Šé™å¸¸æ•¸ç®¡ç†

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹

### å¾Œç«¯æŠ€è¡“æ£§

- **æ¡†æ¶**: ASP.NET Core 9.0
- **è³‡æ–™åº«**: SQL Serverï¼ˆé€é Entity Framework Coreï¼‰
- **ORM**: Entity Framework Core 9.0
- **èªè­‰**: Microsoft Identity Web 4.0
- **ç‰©ä»¶å°æ‡‰**: AutoMapper
- **API æ–‡ä»¶**: Swagger/OpenAPI

### å‰ç«¯æŠ€è¡“æ£§

- **CSS æ¡†æ¶**: Tailwind CSS 4.1
- **å»ºç½®å·¥å…·**: Vite 7.1

### Azure æœå‹™æ•´åˆ

- **Azure Active Directory**: èº«ä»½é©—è­‰èˆ‡æˆæ¬Š
- **Azure Key Vault**: æ•æ„Ÿè³‡è¨Šå„²å­˜
- **Azure Blob Storage**: æª”æ¡ˆå„²å­˜æœå‹™

### é–‹ç™¼å·¥å…·

- **.NET SDK**: 9.0.304
- **Hot Reload**: å•Ÿç”¨ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰

## ğŸ“¦ ç³»çµ±éœ€æ±‚

- [.NET 9.0 SDK](https://dotnet.microsoft.com/download/dotnet/9.0) æˆ–æ›´æ–°ç‰ˆæœ¬
- [SQL Server](https://www.microsoft.com/sql-server) 2019 æˆ–æ›´æ–°ç‰ˆæœ¬ï¼ˆæˆ– Azure SQL Databaseï¼‰
- [Node.js](https://nodejs.org/) 18.0 æˆ–æ›´æ–°ç‰ˆæœ¬ï¼ˆç”¨æ–¼ Tailwind CSS å»ºç½®ï¼‰
- Azure è¨‚é–±ï¼ˆç”¨æ–¼ Azure ADã€Key Vaultã€Blob Storageï¼‰

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. è¤‡è£½å°ˆæ¡ˆ

```bash
git clone https://github.com/isandyzhang/CanLove_Backend.git
cd CanLove_Backend
```

### 2. å®‰è£ä¾è³´

```bash
# é‚„åŸ .NET å¥—ä»¶
dotnet restore

# å®‰è£ Node.js ä¾è³´ï¼ˆç”¨æ–¼ Tailwind CSSï¼‰
npm install
```

### 3. è¨­å®šç’°å¢ƒè®Šæ•¸

è¤‡è£½ `appsettings.json` ä¸¦å»ºç«‹ `appsettings.Development.json`ï¼š

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=CanLoveDb;Trusted_Connection=True;TrustServerCertificate=True;",
    "AzureBlobStorage": "ä½ çš„ Azure Blob Storage é€£æ¥å­—ä¸²"
  },
  "AzureAd": {
    "Instance": "https://login.microsoftonline.com/",
    "Domain": "canlove.org.tw",
    "TenantId": "ä½ çš„ Tenant ID",
    "ClientId": "ä½ çš„ Client ID",
    "ClientSecret": "ä½ çš„ Client Secret",
    "CallbackPath": "/signin-oidc"
  },
  "KeyVault": {
    "VaultUri": "https://canlove-case.vault.azure.net/"
  }
}
```

### 4. åŸ·è¡Œè³‡æ–™åº«é·ç§»

```bash
dotnet ef database update --project . --startup-project .
```

### 5. å»ºç½®å‰ç«¯æ¨£å¼ï¼ˆå¯é¸ï¼‰

```bash
# é–‹ç™¼æ¨¡å¼ï¼ˆç›£è½æª”æ¡ˆè®Šæ›´ï¼‰
npm run dev:css

# æˆ–å»ºç½®ç”Ÿç”¢ç‰ˆæœ¬
npm run build:css
```

### 6. åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼

```bash
dotnet run
```

æ‡‰ç”¨ç¨‹å¼å°‡åœ¨ `https://localhost:7217` å•Ÿå‹•ï¼ˆæˆ–æŸ¥çœ‹ `Properties/launchSettings.json` ä¸­çš„è¨­å®šï¼‰ã€‚

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
CanLove_Backend/
â”œâ”€â”€ Application/              # æ‡‰ç”¨ç¨‹å¼å±¤
â”‚   â”œâ”€â”€ Controllers/         # MVC æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ Account/         # èªè­‰æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ Attendance/     # å‡ºå‹¤ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ Case/           # å€‹æ¡ˆç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ Home/           # é¦–é æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ Staff/          # å“¡å·¥ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ Supply/         # ç‰©è³‡ç®¡ç†æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ Mappings/           # AutoMapper è¨­å®šæª”
â”‚   â””â”€â”€ ViewComponents/     # è¦–åœ–å…ƒä»¶
â”‚
â”œâ”€â”€ Core/                    # æ ¸å¿ƒåŠŸèƒ½å±¤
â”‚   â”œâ”€â”€ Authentication/     # èªè­‰ç›¸é—œï¼ˆäº‹ä»¶è™•ç†ã€Cookie è¼”åŠ©ï¼‰
â”‚   â”œâ”€â”€ DataProtection/     # è³‡æ–™ä¿è­·è¨­å®š
â”‚   â”œâ”€â”€ Extensions/         # æ“´å……æ–¹æ³•
â”‚   â”œâ”€â”€ Middleware/         # è‡ªè¨‚ä¸­ä»‹è»Ÿé«”ï¼ˆéŒ¯èª¤è™•ç†ï¼‰
â”‚   â””â”€â”€ TagHelpers/         # æ¨™ç±¤è¼”åŠ©ç¨‹å¼
â”‚
â”œâ”€â”€ Domain/                  # é ˜åŸŸå±¤ï¼ˆæ¥­å‹™é‚è¼¯ï¼‰
â”‚   â”œâ”€â”€ Case/               # å€‹æ¡ˆé ˜åŸŸ
â”‚   â”‚   â”œâ”€â”€ Models/         # é ˜åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Services/       # æ¥­å‹™æœå‹™
â”‚   â”‚   â””â”€â”€ ViewModels/     # è¦–åœ–æ¨¡å‹
â”‚   â””â”€â”€ Staff/              # å“¡å·¥é ˜åŸŸ
â”‚
â”œâ”€â”€ Infrastructure/          # åŸºç¤è¨­æ–½å±¤
â”‚   â”œâ”€â”€ Data/               # è³‡æ–™å­˜å–
â”‚   â”‚   â”œâ”€â”€ Contexts/       # DbContext
â”‚   â”‚   â”œâ”€â”€ Migrations/     # EF Core é·ç§»æª”
â”‚   â”‚   â”œâ”€â”€ Audit/          # å¯©è¨ˆæ—¥èªŒ
â”‚   â”‚   â””â”€â”€ History/        # æ­·å²è¨˜éŒ„
â”‚   â”œâ”€â”€ Options/            # é¸é …è¨­å®š
â”‚   â””â”€â”€ Storage/            # å„²å­˜æœå‹™ï¼ˆBlobã€åŠ å¯†ï¼‰
â”‚
â”œâ”€â”€ Models/                  # å…±ç”¨æ¨¡å‹
â”‚   â”œâ”€â”€ Api/                # API è«‹æ±‚/å›æ‡‰æ¨¡å‹
â”‚   â””â”€â”€ Mvc/                # MVC æ¨¡å‹
â”‚
â”œâ”€â”€ Views/                   # Razor è¦–åœ–
â”‚   â”œâ”€â”€ Account/            # èªè­‰è¦–åœ–
â”‚   â”œâ”€â”€ Attendance/         # å‡ºå‹¤ç®¡ç†è¦–åœ–
â”‚   â”œâ”€â”€ Case/               # å€‹æ¡ˆç®¡ç†è¦–åœ–
â”‚   â”œâ”€â”€ Home/               # é¦–é è¦–åœ–
â”‚   â”œâ”€â”€ Shared/             # å…±ç”¨è¦–åœ–å…ƒä»¶
â”‚   â”œâ”€â”€ Staff/              # å“¡å·¥ç®¡ç†è¦–åœ–
â”‚   â””â”€â”€ Supply/             # ç‰©è³‡ç®¡ç†è¦–åœ–
â”‚
â”œâ”€â”€ wwwroot/                 # éœæ…‹æª”æ¡ˆ
â”‚   â”œâ”€â”€ css/                # æ¨£å¼è¡¨ï¼ˆTailwind CSSï¼‰
â”‚   â”œâ”€â”€ js/                 # JavaScript æª”æ¡ˆ
â”‚   â””â”€â”€ ...                 # åœ–ç‰‡ç­‰å…¶ä»–éœæ…‹è³‡æº
â”‚
â”œâ”€â”€ docs/                    # æ–‡ä»¶
â”œâ”€â”€ Program.cs               # æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é»
â”œâ”€â”€ appsettings.json        # æ‡‰ç”¨ç¨‹å¼è¨­å®šæª”
â””â”€â”€ CanLove_Backend.csproj  # å°ˆæ¡ˆæª”
```

## âš™ï¸ ç’°å¢ƒè¨­å®š

### é–‹ç™¼ç’°å¢ƒ

1. **è³‡æ–™åº«é€£æ¥å­—ä¸²**
   - è¨­å®š `ConnectionStrings:DefaultConnection` æŒ‡å‘æœ¬åœ° SQL Server

2. **Azure AD è¨­å®š**
   - åœ¨ Azure Portal è¨»å†Šæ‡‰ç”¨ç¨‹å¼
   - è¨­å®šå›èª¿ URLï¼š`https://localhost:7217/signin-oidc`
   - å–å¾— `TenantId`ã€`ClientId`ã€`ClientSecret`

3. **Azure Blob Storageï¼ˆå¯é¸ï¼‰**
   - å»ºç«‹å„²å­˜é«”å¸³æˆ¶
   - å–å¾—é€£æ¥å­—ä¸²

4. **Azure Key Vaultï¼ˆå¯é¸ï¼‰**
   - é–‹ç™¼ç’°å¢ƒå¯è·³éï¼Œä½¿ç”¨ `appsettings.Development.json` å³å¯

### ç”Ÿç”¢ç’°å¢ƒ

1. **Azure Key Vault**
   - å°‡æ•æ„Ÿè³‡è¨Šï¼ˆé€£æ¥å­—ä¸²ã€Client Secret ç­‰ï¼‰å„²å­˜åœ¨ Key Vault
   - è¨­å®š Managed Identity æˆ– Service Principal

2. **Data Protection é‡‘é‘°**
   - ç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ Azure Key Vault æˆ–å…±äº«å„²å­˜
   - å¤šä¼ºæœå™¨ç’°å¢ƒå¿…é ˆå…±äº«é‡‘é‘°

3. **HTTPS**
   - å¿…é ˆä½¿ç”¨ HTTPSï¼ˆFormPost æ¨¡å¼è¦æ±‚ï¼‰
   - è¨­å®š SSL æ†‘è­‰

## ğŸ’» é–‹ç™¼æŒ‡å—

### è³‡æ–™åº«é·ç§»

```bash
# å»ºç«‹æ–°çš„é·ç§»
dotnet ef migrations add MigrationName --project . --startup-project .

# å¥—ç”¨é·ç§»
dotnet ef database update --project . --startup-project .

# æª¢è¦– SQL è…³æœ¬ï¼ˆä¸åŸ·è¡Œï¼‰
dotnet ef migrations script --project . --startup-project .
```

### å‰ç«¯æ¨£å¼é–‹ç™¼

```bash
# é–‹ç™¼æ¨¡å¼ï¼ˆè‡ªå‹•é‡æ–°ç·¨è­¯ï¼‰
npm run dev:css

# å»ºç½®ç”Ÿç”¢ç‰ˆæœ¬
npm run build:css
```

### èªè­‰æµç¨‹èªªæ˜

1. ä½¿ç”¨è€…è¨ªå•å—ä¿è­·çš„é é¢
2. é‡å®šå‘åˆ° Azure AD ç™»å…¥é 
3. ä½¿ç”¨è€…å®Œæˆèªè­‰
4. Azure AD å›èª¿åˆ°æ‡‰ç”¨ç¨‹å¼ï¼ˆFormPost æ¨¡å¼ï¼‰
5. æ‡‰ç”¨ç¨‹å¼å»ºç«‹èªè­‰ Cookie
6. å¾ŒçºŒè«‹æ±‚ä½¿ç”¨ Cookie è­˜åˆ¥ä½¿ç”¨è€…

### æœå‹™è¨»å†Š

æ‰€æœ‰æ¥­å‹™æœå‹™åœ¨ `Program.cs` çš„ `RegisterApplicationServices()` æ–¹æ³•ä¸­è¨»å†Šï¼Œä½¿ç”¨ä¾è³´æ³¨å…¥ï¼ˆDIï¼‰æ¨¡å¼ã€‚

ç”Ÿå‘½é€±æœŸï¼š
- **Scoped**ï¼šæ¯å€‹ HTTP è«‹æ±‚å»ºç«‹ä¸€å€‹å¯¦ä¾‹ï¼ˆæœ€å¸¸ç”¨ï¼‰
- **Singleton**ï¼šæ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚å»ºç«‹ä¸€æ¬¡
- **Transient**ï¼šæ¯æ¬¡æ³¨å…¥æ™‚å»ºç«‹æ–°å¯¦ä¾‹

## ğŸš¢ éƒ¨ç½²èªªæ˜

### Azure App Service éƒ¨ç½²

1. **å»ºç«‹ App Service**
   - é¸æ“‡ .NET 9.0 åŸ·è¡Œéšæ®µå †ç–Š
   - å•Ÿç”¨ Managed Identity

2. **è¨­å®šæ‡‰ç”¨ç¨‹å¼è¨­å®š**
   - åœ¨ App Service è¨­å®šä¸­æ–°å¢å¿…è¦çš„è¨­å®šå€¼
   - æˆ–ä½¿ç”¨ Azure Key Vault åƒè€ƒ

3. **è¨­å®šè³‡æ–™åº«**
   - å»ºç«‹ Azure SQL Database
   - æ›´æ–°é€£æ¥å­—ä¸²

4. **éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼**
   ```bash
   dotnet publish -c Release
   # ä½¿ç”¨ Azure CLI æˆ– Visual Studio éƒ¨ç½²
   ```

### CI/CD

å°ˆæ¡ˆåŒ…å« GitHub Actions å·¥ä½œæµç¨‹ï¼ˆ`.github/workflows/main_canlovemanagementsystem.yml`ï¼‰ï¼Œå¯è‡ªå‹•åŒ–å»ºç½®å’Œéƒ¨ç½²æµç¨‹ã€‚

## ğŸ“ é‡è¦æ³¨æ„äº‹é …

### Cookie è¨­å®š

- **Correlation Cookie**ï¼šä½¿ç”¨ `SameSite=None` + `Secure`ï¼ˆFormPost æ¨¡å¼è¦æ±‚ï¼‰
- **èªè­‰ Cookie**ï¼šä½¿ç”¨ `SameSite=Lax`ï¼ˆä¸€èˆ¬ä½¿ç”¨ï¼‰
- ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨ HTTPS

### Data Protection é‡‘é‘°

- å¿…é ˆæŒä¹…åŒ–é‡‘é‘°ï¼Œå¦å‰‡é‡å•Ÿå¾Œç„¡æ³•è§£å¯† Cookie
- å¤šä¼ºæœå™¨ç’°å¢ƒå¿…é ˆå…±äº«é‡‘é‘°

### èªè­‰ä¸­ä»‹è»Ÿé«”é †åº

ä¸­ä»‹è»Ÿé«”é †åºéå¸¸é‡è¦ï¼š
1. `UseRouting()`
2. `UseAuthentication()`
3. `UseAuthorization()`

## ğŸ¤ è²¢ç»

æ­¡è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ æˆæ¬Š

æœ¬å°ˆæ¡ˆç‚º CanLove çµ„ç¹”æ‰€æœ‰ã€‚

## ğŸ“ è¯çµ¡è³‡è¨Š

- **GitHub**: [isandyzhang/CanLove_Backend](https://github.com/isandyzhang/CanLove_Backend)
- **Issues**: [GitHub Issues](https://github.com/isandyzhang/CanLove_Backend/issues)

---

**æ³¨æ„**ï¼šæ­¤å°ˆæ¡ˆåŒ…å«æ•æ„Ÿè³‡è¨Šï¼Œè«‹å‹¿å°‡ `appsettings.json` ä¸­çš„å¯¦éš›è¨­å®šå€¼æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»çµ±ã€‚ä½¿ç”¨ `appsettings.Development.json`ï¼ˆå·²åŠ å…¥ .gitignoreï¼‰é€²è¡Œæœ¬åœ°é–‹ç™¼ã€‚
